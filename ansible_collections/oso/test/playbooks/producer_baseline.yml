---
# Producer Configuration Baseline Tests (PRD Scenario 1)
# Purpose: Identify optimal producer settings
#
# Usage:
#   ansible-playbook -i inventories/dev playbooks/producer_baseline.yml
#   ansible-playbook -i inventories/dev playbooks/producer_baseline.yml -e "test_profile=quick"
#   ansible-playbook -i inventories/dev playbooks/producer_baseline.yml --tags "producer,baseline"

- name: Producer Configuration Baseline (PRD Scenario 1)
  hosts: all
  gather_facts: true
  tags:
    - producer
    - baseline

  vars:
    scenario_name: "producer_baseline"
    test_profile: "quick"  # Options: baseline, quick

    # Load test matrix based on profile
    test_acks: "{{ producer_test_matrix[test_profile].acks | default(['1']) }}"
    test_batch_sizes: "{{ producer_test_matrix[test_profile].batch_size | default([16384]) }}"
    test_linger_values: "{{ producer_test_matrix[test_profile].linger_ms | default([10]) }}"
    test_compression_types: "{{ producer_test_matrix[test_profile].compression_type | default(['zstd']) }}"
    test_record_sizes: "{{ producer_test_matrix[test_profile].record_size | default([1024]) }}"

    # Override defaults
    perf_num_records: "{{ perf_defaults.num_records | default(1000000) }}"
    perf_throughput: "{{ perf_defaults.throughput | default(-1) }}"
    perf_buffer_memory: "{{ perf_defaults.buffer_memory | default(67108864) }}"
    perf_max_inflight: "{{ perf_defaults.max_inflight | default(5) }}"

  tasks:
    - name: Display test configuration
      ansible.builtin.debug:
        msg: |
          Producer Baseline Test Configuration:
            Profile: {{ test_profile }}
            acks values: {{ test_acks }}
            batch.size values: {{ test_batch_sizes }}
            linger.ms values: {{ test_linger_values }}
            compression types: {{ test_compression_types }}
            record sizes: {{ test_record_sizes }}
            Total combinations: {{ test_acks | length * test_batch_sizes | length * test_linger_values | length * test_compression_types | length * test_record_sizes | length }}
      run_once: true

    - name: Setup test environment
      ansible.builtin.include_role:
        name: setup_environment
      run_once: true

    - name: Run producer baseline tests - acks variations
      ansible.builtin.include_role:
        name: perf_producer
      vars:
        scenario_name: "baseline_acks{{ item.0 }}_batch{{ item.1 }}_linger{{ item.2 }}_{{ item.3 }}_size{{ item.4 }}"
        perf_acks: "{{ item.0 }}"
        perf_batch_size: "{{ item.1 }}"
        perf_linger_ms: "{{ item.2 }}"
        perf_compression_type: "{{ item.3 }}"
        perf_record_size: "{{ item.4 }}"
      loop: "{{ test_acks | product(test_batch_sizes, test_linger_values, test_compression_types, test_record_sizes) | list }}"
      loop_control:
        label: "acks={{ item.0 }}, batch={{ item.1 }}, linger={{ item.2 }}, compression={{ item.3 }}, size={{ item.4 }}"

    - name: Parse test logs
      ansible.builtin.include_role:
        name: log_parser
      run_once: true

    - name: Generate Excel report
      ansible.builtin.include_role:
        name: excel_generator
      when: test_options.generate_report | default(true) | bool
      run_once: true

    - name: Cleanup test environment
      ansible.builtin.include_role:
        name: cleanup
      vars:
        delete_test_topics: "{{ test_options.cleanup_topics | default(true) }}"
      run_once: true

    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          Producer Baseline Tests Complete!

          Results:
            Tests executed: {{ producer_tests_completed | default([]) | length }}
            Reports: {{ reports_dir }}/

          To view detailed results, open the Excel report.
      run_once: true
