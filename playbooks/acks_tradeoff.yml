---
# Acknowledgment Trade-off Tests (PRD Scenario 5)
# Purpose: Quantify durability vs. performance impact
#
# Usage:
#   ansible-playbook -i inventories/dev playbooks/acks_tradeoff.yml
#   ansible-playbook -i inventories/dev playbooks/acks_tradeoff.yml -e "test_acks=['1','all']"

- name: Acknowledgment Trade-off Tests (PRD Scenario 5)
  hosts: all
  gather_facts: true
  tags:
    - acks
    - tradeoff
    - durability

  vars:
    scenario_name: "acks_tradeoff"

    # Acks parameters
    test_acks: "{{ acks_tradeoff_matrix.acks | default(['0', '1', 'all']) }}"
    test_replication_factors: "{{ acks_tradeoff_matrix.replication_factor | default([3]) }}"

    # Fixed producer settings
    perf_batch_size: "{{ acks_tradeoff_matrix.batch_size | default(16384) }}"
    perf_linger_ms: "{{ acks_tradeoff_matrix.linger_ms | default(10) }}"
    perf_record_size: "{{ acks_tradeoff_matrix.record_size | default(1024) }}"
    perf_compression_type: "zstd"
    perf_num_records: "{{ perf_defaults.num_records | default(1000000) }}"

  tasks:
    - name: Display test configuration
      ansible.builtin.debug:
        msg: |
          Acknowledgment Trade-off Test Configuration:
            acks values: {{ test_acks }}
            Replication factors: {{ test_replication_factors }}
            Fixed settings:
              batch.size: {{ perf_batch_size }}
              linger.ms: {{ perf_linger_ms }}
              record.size: {{ perf_record_size }}
              compression: {{ perf_compression_type }}
            Total combinations: {{ test_acks | length * test_replication_factors | length }}

          Trade-off Analysis:
            acks=0: Fire-and-forget (fastest, no durability)
            acks=1: Leader acknowledgment (balanced)
            acks=all: All replicas (strongest durability, slowest)
      run_once: true

    - name: Run acks trade-off tests for each replication factor
      ansible.builtin.include_tasks: acks_tradeoff_iteration.yml
      vars:
        replication_factor: "{{ rf_item }}"
      loop: "{{ test_replication_factors }}"
      loop_control:
        loop_var: rf_item
        label: "Replication factor {{ rf_item }}"

    - name: Parse test logs
      ansible.builtin.include_role:
        name: log_parser
      run_once: true

    - name: Generate Excel report
      ansible.builtin.include_role:
        name: excel_generator
      when: test_options.generate_report | default(true) | bool
      run_once: true

    - name: Cleanup test environment
      ansible.builtin.include_role:
        name: cleanup
      vars:
        delete_test_topics: "{{ test_options.cleanup_topics | default(true) }}"
      run_once: true

    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          Acknowledgment Trade-off Tests Complete!

          Results:
            acks values tested: {{ test_acks }}
            Replication factors: {{ test_replication_factors }}
            Reports: {{ reports_dir }}/

          Key Insight: Review the Acknowledgment Trade-offs sheet in the Excel report
          to understand the durability vs. performance relationship.
      run_once: true
